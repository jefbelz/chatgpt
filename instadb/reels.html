<!DOCTYPE html>
<html lang="en" class="dark" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lilia Database</title>

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">

    <style type="text/css" class="init"></style>

    <script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script type="text/javascript" class="init"></script>
    <style>
        #logo {
            margin-right: 30px; /* Adjust the margin as needed */
        }


        #userSelect {
            width: 100%;
            max-width: 450px; /* Adjust the max-width as needed */
            margin-bottom: 15px; /* Add some space between the select and the table */
        }
    </style>

    </style>
</head>
<body>
<table class="table">
    <tr>
        <td><img id="logo" src="logolilia.png" alt="Logo"> </td>
        <td><br><br><h2>Reels parsed database</h2></td>
    </tr>
</table>

<select id="userSelect">
    <!-- Options will be dynamically populated by JavaScript -->
</select>

<table id="example" class="display table table-striped dataTable">
    <thead>
    <tr>
        <th>User</th>
        <th>URL</th>
        <th>Caption</th>
        <th>Likes</th>
        <th>Views</th>
        <th>Comments</th>
        <th>Taken at</th>
        <th>Text On video</th>
        <th>Analysis</th>
        <th>Transcription</th>
        <th>Video</th>
        <th>Duration</th>

    </tr>
    </thead>
    <tbody>
    <!-- Table rows will be dynamically populated by DataTables -->
    </tbody>
</table>

<button id="exportCSVBtn" class="button"><i class="fas fa-file-csv"></i> Export to CSV</button>

<script>
    var jsonData; // Variable to store JSON data

    function loadJSON() {
        var resultDiv = document.getElementById('result');
        var xhr = new XMLHttpRequest();

        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    try {

                        jsonData = JSON.parse(xhr.responseText);

                        // Populate the dropdown with user options
                        var userSelect = document.getElementById('userSelect');
                        var allOption = document.createElement('option');
                        allOption.value = 'all';
                        allOption.textContent = 'ALL';
                        userSelect.appendChild(allOption);

                        jsonData.forEach(function (user) {
                            var option = document.createElement('option');
                            option.value = user.userId;
                            option.textContent = user.user_profile;
                            userSelect.appendChild(option);
                        });

                        // Initialize DataTable with the first user's reels
                        var initialUserId = jsonData[0].userId;
                        userSelect.value=initialUserId
                        updateDataTable(initialUserId);

                        // Update DataTable when user selection changes
                        userSelect.addEventListener('change', function () {
                            var selectedUserId = this.value;
                            updateDataTable(selectedUserId);
                        });

                        resultDiv.innerHTML = "<pre>" + JSON.stringify(jsonData, null, 2) + "</pre>";
                    } catch (error) {
                        resultDiv.innerHTML = "Error parsing JSON file: " + error.message;
                    }
                } else {
                    resultDiv.innerHTML = "Error loading JSON file. Status: " + xhr.status;
                }
            }
        };

        xhr.open('GET', 'reels.json', true);
        xhr.send();
    }

    function updateDataTable(userId) {
        var userReels;

        if (userId === 'all') {
            userReels = [].concat(...jsonData.map(user => user.reels));
        } else {
            var selectedUser = jsonData.find(function (user) {
                return user.userId === userId;
            });
            userReels = selectedUser.reels;
        }
        var table = $('#example').DataTable();
        if ($.fn.dataTable.isDataTable('#example')) {
            table.destroy();
        }

        $('#example').DataTable({
            scrollCollapse: true,
            scrollY: '50vh',
            scrollX: true,
            data: userReels,
            responsive: true,
            columns: [
                { data: 'username', searchable: true, width: '4%' },
                { data: 'url',
                    searchable: false,
                    render: function (data, type, row) {
                        return '<a href="' + data + '" target="_blank">reel</a>';
                    }, width: '4%'
                },
                {
                 data: 'text',
                 searchable: true,
                 width: '10%',
                    render: function (data, type, row) {
                        var formattedText = data.replace(/\n/g, '<br>');
                        return formattedText;
                    }
                },
                { data: 'like_count', searchable: true, width: '4%' ,  render: function (data, type, row) {
                    return data.toLocaleString(); // Example: 1,234
                }},
                { data: 'view_count', searchable: true, width: '4%'   ,  render: function (data, type, row) {
                    return data.toLocaleString(); // Example: 1,234
                }},
                { data: 'comment_count', searchable: true, width: '4%'  ,  render: function (data, type, row) {
                    return data.toLocaleString(); // Example: 1,234
                }},
                { data: 'taken_at', searchable: true, width: '4%',
                  render: function (data, type, row) {
                    // Convert the ISO date string to a Date object
                    var date = new Date(data);
                    var formattedDate = date.toLocaleString('en-RU', {
                        year: '2-digit',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    return formattedDate;
                  }
                },
                { data: 'text_on_video', searchable: true, width: '15%'  ,
                    render: function (data, type, row) {
                        var formattedText = data.replace(/\n/g, '<br>');
                        return formattedText;
                    }
                },
                { data: 'video_analysis', searchable: false ,width: '25%' ,
                    render: function (data, type, row) {
                        var formattedText = data.replace(/\n/g, '<br>');
                        return formattedText;
                    }
                },
                { data: 'video_transcription', searchable: false , width: '15%' ,
                    render: function (data, type, row) {
                        var formattedText = data.replace(/\n/g, '<br>');
                        return formattedText;
                    }
                },

                { data: 'video_url',
                    searchable: false,
                    render: function (data, type, row) {
                        return '<a href="' + data + '" target="_blank">Video</a>';
                    }, width: '4%'
                },
                { data: 'video_duration', searchable: false , width: '4%' },
            ],
            lengthMenu: [
                [20, 50, -1],
                [20, 50, 'All']
            ],
            initComplete: function () {
                this.api().columns().every(function (index) {
                    var column = this;
                    var input = document.createElement("input");
                    var columnsToExclude = [0,1,2,3 ,4, 5,6, 7,8,9,10,11];

                    if (columnsToExclude.indexOf(index) === -1) {
                        $(input).appendTo($(column.header())).on('keyup change', function () {
                            column.search($(this).val(), false, false, true).draw();
                        });
                    } else {
                        $("</br></br>").appendTo($(column.header()))
                    }
                });
            },
            dom: '<"top"lp<"clear">>rt<"bottom"if<"clear">>',
            buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
        });
    }

    function convertToCSV(data) {
        var csv = '';
        csv += Object.keys(data[0]).join(',') + '\n';
        data.forEach(function (item) {
            csv += Object.values(item).join(',') + '\n';
        });

        return csv;
    }

    function downloadCSV(csvContent, fileName) {
        var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        var link = document.createElement('a');

        if (link.download !== undefined) {
            var url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    function exportToCSV() {
        var table = $('#example').DataTable();
        var visibleColumnsData = table.columns(':visible').rows({ search: 'applied' }).data().toArray();
        var csvContent = convertToCSV(visibleColumnsData);
        downloadCSV(csvContent, 'filtered_data.csv');
    }

    document.getElementById('exportCSVBtn').addEventListener('click', exportToCSV);

    loadJSON();

</script>
</body>
</html>
